<script>
    async function fetchIP() {
        try {
            const response = await fetch('/api/ip');
            const data = await response.json();
            document.getElementById('ip_button').innerText = data.ip;
        } catch (error) {
            document.getElementById('ip_button').innerText = 'IP not available';
        }
    }
    let topic;
    let mesage;
    document.addEventListener('DOMContentLoaded', () => {
        // Replace with your WebSocket server address
        const serverIp = "{{ server_ip }}";
        const ws = new WebSocket(`ws://192.168.1.136:8765`);

        ws.onopen = () => {
            document.getElementById('status').textContent = 'Connected';
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            topic = message.topic;
            console.log(`topic: ${topic}`)
            data = message.data
            console.log(`data: ${data}`)
            if (topic === 'cansocket/stats') {
                updateCANStatus(data);
            }
        };

        
        ws.onclose = () => {
            document.getElementById('status').textContent = 'Disconnected';
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            document.getElementById('status').textContent = 'Error';
        };

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-GB', options);
            document.getElementById('time').innerText = `${dateString} ${timeString}`;
        }

        
        function updateCANStatus(data){
            document.getElementById('CANbitrate').innerText = data.CANbitrate;
            document.getElementById('CANstate').innerText = data.CANstate;
            document.getElementById('CANRXbytes').innerText = data.CANRXbytes
            
        }

        updateTime();
        setInterval(updateTime, 1000);
            
        fetchIP();
        // setInterval(fetchIP, 3001);

    });
</script>
<style>
    #footer-button-container {
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    }
    .footer-button {
        background-color: inherit;
        color: inherit;
        border: 0px;
        font-size: 50px;
        cursor: pointer;
        margin: 1; /* Remove margin from the refresh button */
        width: 100%;
    }
    .footer-button:hover {
        background-color: darkgray;
        color: lightgreen;
    }
</style>
<footer>
    <div>
        <span id="time"></span>
    </div>
    <div>
        CAN&nbsp;<span id="CANstate">state</span>&nbsp;(<span id="CANbitrate">bitrate</span>)&nbsp;RX:<span id="CANRXbytes">bitrate</span>
    </div>
    <div>
        <button class="footer-button" id="ip_button" onclick="fetchIP()"></button>
    </div>
</footer>
