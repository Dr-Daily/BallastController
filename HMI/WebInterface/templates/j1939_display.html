<!-- templates/j1939_display.html -->
{% extends 'base.html' %}

{% block title %}Ballast Controller{% endblock %}

{% block content %}
<script>
        function setBitrate(event) {
            event.preventDefault(); // Prevent the form from submitting normally
            var bitrate = document.getElementById("bitrate-select").value;
            if (bitrate) {
                fetch('/api/start_can', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'bitrate': bitrate
                    })
                })
                .then(response => response.json())
                
                .then(data => {
                    if (data.status === "success") {
                        alert("Bitrate set successfully!");
                    } else {
                        alert("Error: " + data.message);
                    }
                })
                .catch(error => alert("An error occurred: " + error));
            } else {
                alert("Please select a bitrate.");
            }
        }
</script>
<style>
    .sa-button{
        font-size: inherit;
        background-color: steelblue;
        color: white;
        width: 100%;
        text-align: left;
    }
    .sa-container{
        justify-content: left; 
        
        text-align: left;
    }
    .pgn-button{
        font-size: 48pt;
        background-color: rgb(72, 5, 76);
        text-align: left;
        color: white;
        width: 100%;
    }
    .pgn-container{
        justify-content: left; 
        
        text-align: left;
    }

</style>

<div class="grid-cell" style="align-items: top;" id="can-commands">
    <form  id="bitrate-form" method="POST">
        <!-- <label for="bitrate-select">CAN bitrate:</label> -->
        <select id="bitrate-select"  name="bitrate" onchange="setBitrate(event)">
            <option value="" selected disabled>Bus Speed</option>
            <option value="125000">125k</option>
            <option value="250000">250k</option>
            <option value="500000">500k</option>
            <option value="666666">666k</option>
            <option value="1000000">1M</option>
        </select>
    </form>
    <!-- <button class=control-button type="submit">Start CAN</button> -->
    <div class= sa-container id="source-addresses">
    <h4>Sources</h4>
        SA: Name (count)
        <div class="sa-container" id="buttons-container">
            <!-- Buttons will be dynamically inserted here -->
        </div>
        
    </div>

</div>
<div class="pgn-container" id="pgn-container">
    <!-- Data will be dynamically displayed here -->
</div>
<div class="grid-cell" id="data-container">
    <!-- Data will be dynamically displayed here -->
</div>
<div class="grid-cell" id="j1939-graphs">
    <!-- Data will be dynamically displayed here -->
</div>

<script src="{{ url_for('static', filename='js/mqtt.min.js') }}"></script>
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", () => {
        // Connect to the local MQTT broker
        const serverIp = "{{ server_ip }}";
        const brokerUrl = `ws://${serverIp}:8080`;
        // Connect to the MQTT broker on the server
        const client = mqtt.connect(brokerUrl);
        
        // Set the topic you want to subscribe to
        const topic = 'j1939/stats';

        // Called when the client connects
        client.on('connect', () => {
            console.log('Connected to MQTT broker');
            client.subscribe(topic, (err) => {
                if (!err) {
                    console.log(`Subscribed to topic: ${topic}`);
                }
            });
        });

        // Called when a message arrives
        client.on('message', (topic, message) => {
            // message is a Buffer, convert it to string
            const data = message.toString();
            
            // console.log(`Received message: ${data}`);
            const CANData = JSON.parse(data);
            
            const buttonsContainer = document.getElementById('buttons-container');
            buttonsContainer.innerHTML = ''; // Clear previous buttons

            for (const sa in CANData.Source) {
                if (data.hasOwnProperty(sa)) {
                    const item = CANData.Source[sa];
                    const button = document.createElement('button');
                    button.textContent = sa + ": " + item.name + " (" + item.count + ")";
                    button.setAttribute('data-key', sa);
                    button.setAttribute('class','sa-button')
                    button.addEventListener('click', function() {
                        displayPGN(item);
                    });
                    button.addEventListener('hover', function() {
                        displayPGN(item);
                    });
                    // Append the button to the buttons container
                    buttonsContainer.appendChild(button);
                    // Add a <br> tag after each button
                    buttonsContainer.appendChild(document.createElement('br'));
                }
            }
        });


        // Called when the client disconnects
        client.on('close', () => {
            console.log('Disconnected from MQTT broker');
        });
    });

    function displayPGN(item) {
        console.log(item);
        const dataContainer = document.getElementById('pgn-container');
        dataContainer.innerHTML = ''; // Clear previous data

        const nameDiv = document.createElement('div');
        nameDiv.className = 'name';
        nameDiv.textContent = "Source Address " + item.address + ":" + item.name;

        const pgnDiv = document.createElement('div');
        pgnDiv.className = 'pgns';
        const header_txt = document.createElement('span');
        header_txt.textContent = "PGN (CAN ID) period [count]"
        pgnDiv.appendChild(header_txt)
        for (const pgn in item.pgns) {
                if (item.pgns.hasOwnProperty(pgn)) {
                    const values = item.pgns[pgn];
                    const button = document.createElement('button');
                    button.textContent = pgn + " (" + values.id + ") " + values.time_delta + " [" + values.count + "]";
                    button.setAttribute('data-key', pgn);
                    button.setAttribute('class','pgn-button')
                    button.addEventListener('click', function() {
                        displayData(values);
                    });
                    // Append the button to the buttons container
                    pgnDiv.appendChild(button);
                    pgnDiv.appendChild(document.createElement('br'));
                }
            }
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item';
        itemDiv.appendChild(nameDiv);
        itemDiv.appendChild(pgnDiv);

        // Append the item div to the data container
        dataContainer.appendChild(itemDiv);
    }

    function displayData(item) {
        console.log(item);
        const dataContainer = document.getElementById('data-container');
        // dataContainer.innerHTML = 'PGN (CAN ID) period [count]'; // Clear previous data

        // const nameDiv = document.createElement('div');
        // nameDiv.className = 'name';
        // nameDiv.textContent = "Source Address " + item.address + "<br>" + item.name;

        // const pgnDiv = document.createElement('div');
        // pgnDiv.className = 'pgns';
        // for (const pgn in item.pgns) {
        //         if (item.hasOwnProperty(pgn)) {
        //             const values = item.pgns[pgn];
        //             const button = document.createElement('button');
        //             button.textContent = pgn + " (" + values.id + ") " + values.time_delta + " [" + values.count + "]";
        //             button.setAttribute('data-key', pgn);
        //             button.setAttribute('class','pgn-button')
        //             button.addEventListener('click', function() {
        //                 downloadData(item);
        //             });
        //             // Append the button to the buttons container
        //             buttonsContainer.appendChild(button);
        //         }
        //     }
        // pgnDiv.textContent = item.count;
        // pgnDiv.appendChild(pgnDiv);

        // const itemDiv = document.createElement('div');
        // itemDiv.className = 'item';
        // itemDiv.appendChild(nameDiv);
        // itemDiv.appendChild(pgnDiv);

        // // Append the item div to the data container
        // dataContainer.appendChild(itemDiv);
    }
    function downloadData(){
        
    }
</script>

{% endblock %}
